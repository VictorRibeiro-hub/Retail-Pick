
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Retail Pick Productivity Tracker</title>
  <!-- Importa a biblioteca SheetJS para exporta√ß√£o XLSX -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- FontAwesome para √≠cones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* Global Reset e Estilo do Body */
    * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* Faz o body ocupar a altura toda e N√ÉO rolar */
html, body {
  height: 100%;
  overflow: hidden;
  font-family: Arial, sans-serif;
  background-color: #f4f4f4;
  color: #333;
}

    /* Top Bar: fundo vermelho, inclui logo, navega√ß√£o e info do usu√°rio */
    .top-bar {
      background-color: #d32f2f; /* Vermelho */
      color: #fff;
      padding: 15px 20px;
      font-size: 26px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 15px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .top-bar .logo-container {
      display: flex;
      align-items: center;
    }
    .top-bar .logo-container img {
      height: 50px;
      margin-right: 10px;
    }
    .top-bar > span {
      flex-grow: 1;
    }
    /* Bot√µes de Navega√ß√£o na Top Bar */
        /* --- NAV DOS TABS (espa√ßamento uniforme) --- */
    .tab-nav {
      display: flex;
      align-items: center;
      column-gap: 8px;        /* espa√ßo entre bot√µes */
    }

    /* --- BOT√ÉO DE TAB (tamanho e alinhamento consistentes) --- */
    .tab-btn {
      background: transparent;
      border: none;
      color: #fff;
      position: relative;
      cursor: pointer;
      padding: 8px 12px;      /* mais confort√°vel */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;               /* espa√ßo entre √≠cone e texto */
      min-width: 112px;       /* todos com base semelhante */
      transition: color 0.3s, background 0.3s;
    }

    /* Texto no hover, sem empurrar o layout */
    .tab-btn .btn-text {
      font-size: 14px;
      color: yellow;
      opacity: 0;
      max-width: 0;           /* n√£o ocupa espa√ßo quando escondido */
      overflow: hidden;
      transition: max-width 0.25s ease, opacity 0.25s ease;
    }

    .tab-btn:hover .btn-text {
      opacity: 1;
      max-width: 80px;        /* suficiente para "Home", "Gaps" */
    }

    /* Hover com leve realce */
    .tab-btn:hover {
      background: rgba(255,255,255,0.12);
      border-radius: 8px;
    }

    /* Aba ativa: destaque */
    .tab-btn.active {
      background: rgba(255,255,255,0.18);
      border-radius: 8px;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.25) inset;
    }
    .tab-btn.active i {
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4));
    }

    .tab-btn:focus-visible .btn-text {
      opacity: 1;
      max-width: 80px;
    }
    .tab-btn:focus-visible {
      outline: 2px solid rgba(255,255,255,0.35);
      border-radius: 8px;
    }

    .user-info {
      font-size: 12px;
      font-weight: normal;
      opacity: 0.9;
    }
        /* Sidebar: fixa √† esquerda, alinhada logo abaixo da top bar (estilo alinhado ao Online) */
    .sidebar {
      position: fixed;
      top: 70px;              /* alinhado com o modelo Online */
      left: 0;
      bottom: 0;
      width: 240px;
      background-color: #000;
      padding: 30px 20px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 3px 0 8px rgba(0, 0, 0, 0.3);
      color: #fff;
      z-index: 900;
    }

    /* Bot√µes/labels da sidebar com estilo unificado (igual ao Online) */
    .sidebar .file-label,
    .sidebar button {
      text-decoration: none;
      font-size: 16px;
      padding: 8px;
      border: none;
      background: transparent;
      color: #fff;
      text-align: left;
      cursor: pointer;
      transition: background 0.3s, padding-left 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar .file-label:hover,
    .sidebar button:hover {
      background: rgba(255, 255, 255, 0.2);
      padding-left: 20px;
    }

    /* Esconde o input real de arquivo */
    #csvFileInput { display: none; }

    /* Summary Cards no mesmo estilo visual do Online Tracker */
    .summary-card {
      background-color: #1a1a1a;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      margin-top: 8px;
    }

    .summary-number {
      font-size: 20px;
      font-weight: bold;
      margin-top: 4px;
      color: #ffc107;
    }

    /* Main Content: deixa o scroll para o body (como no c√≥digo acabado) */
.main-content {
  margin-left: 240px;  /* Largura da sidebar */
  margin-top: 45px;    /* Altura da top bar */
  padding: 20px;
  overflow-y: auto;    /* Adiciona rolagem vertical */
  height: calc(100vh - 80px); /* Altura total menos a altura da top bar */
}
    /* Conte√∫do das Abas (Home e Gaps) */
    #homeTabContent, #gapsTabContent { margin-top: 20px; }
    /* Tabelas */
   /* Tabelas */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 5px;                 /* igual ao tracker Online */
  background-color: #fff;          /* fundo branco nas tabelas */
  box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* leve sombra */
}

th, td {
  padding: 5px;                    /* ‚Üì menor altura das linhas */
  text-align: center;
  border: 1px solid #ddd;
  word-wrap: break-word;
  line-height: 1.3;                /* deixa o texto mais ‚Äúcompacto‚Äù */
}

/* Sombreado ao passar o mouse nas linhas (Home + Gaps) */
tbody tr:hover {
  background-color: #f1f1f1;
}

   /* =============================
   HEADER FIXO - HOME & GAPS
   ============================= */

/* HOME: 1¬™ linha do cabe√ßalho (t√≠tulos) */
#productivityTable thead tr:nth-child(1) th {
  position: sticky;
  top: 18px;                    /* ‚Üì em vez de 0 */
  z-index: 5;
  background-color: #000;
  color: #fff;
  font-size: 13px;
  padding: 6px;
  border-bottom: 2px solid #333;
}

/* HOME: 2¬™ linha do cabe√ßalho (filtros) */
#productivityTable thead tr.filter-row th {
  position: sticky;
  top: 40px;                   /* ‚Üì 32 + 8 para manter o espa√ßamento */
  z-index: 4;
  background-color: #111;
}

/* GAPS: linha de t√≠tulos */
#gapsTable thead tr:nth-child(1) th {
  position: sticky;
  top: 18px;                    /* ‚Üì em vez de 0 */
  z-index: 5;
  background-color: #000;
  color: #fff;
  font-size: 13px;
  padding: 6px;
  border-bottom: 2px solid #333;
}

/* Sombra suave abaixo do cabe√ßalho */
#productivityTable thead,
#gapsTable thead {
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}


  /* ‚Üê Aqui, logo abaixo: */
  /* Ajuste para coluna Performance sem deformar o layout */
  #productivityTable th:nth-child(8) {
    width: 180px;
  }
  #productivityTable td:nth-child(8) {
    max-width: 180px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

    /* Linha de Filtros Integrada no Cabe√ßalho */
    .filter-row {
      background-color: #000; /* Fundo preto */
      color: #fff; /* Texto branco */
    }
    .filter-row input,
    .filter-row select {
      width: 90%;
      padding: 5px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
/* S√≥ o input + select da coluna User ID (2¬™ coluna da linha de filtros) */
.filter-row th:nth-child(2) input,
.filter-row th:nth-child(2) select {
  width: 70%;      /* antes era 90% ou 80% */
}

    /* Corpo das Tabelas: tamanho da fonte dos dados */
    #productivityTable tbody td,
    #gapsTable tbody td {
      font-size: 14px;
    }
    /* Classes de Performance */
    .performance-well-done { color: #28a745; font-weight: bold; }
    .performance-poor { color: #dc3545; font-weight: bold; }
    .performance-almost-there { color: #ff8c00; font-weight: bold; }
    .performance-no-activity { color: #000; font-weight: bold; }
/* === PREMIUM KPI CARDS === */

.kpi-card {
  width: 100%;                 /* impede o card de ficar largo demais */
  max-width: 200px;            /* limite visual, igual aos summary cards */
  margin: 0 auto;              /* centraliza o card dentro da sidebar */
  background-color: #111;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  word-wrap: break-word;       /* impede que o texto empurre o card */
}

.kpi-card .summary-icon {
  font-size: 20px;
  margin-bottom: 4px;
}

.kpi-card .summary-title {
  font-size: 13px;
  line-height: 14px;
  font-weight: normal;
  color: #fff;
}

.kpi-card .summary-number {
  font-size: 20px;
  font-weight: bold;
  color: #ffc107;
}
/* ROW COM DOIS KPIS LADO A LADO */
.kpi-row {
  width: 100%;
  max-width: 200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background-color: #111;
  padding: 10px 6px;
  border-radius: 8px;
}

/* Cards pequenos (lado a lado) */
.kpi-card-small {
  flex: 1;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.kpi-card-small .summary-icon {
  font-size: 18px;
  margin-bottom: 3px;
}

.kpi-card-small .summary-title {
  font-size: 11px;
  line-height: 13px;
  color: #fff;
}

.kpi-card-small .summary-number {
  font-size: 18px;
  font-weight: bold;
  color: #ffc107;
}

/* Risquinho vertical */
.kpi-separator {
  width: 1px;
  height: 40px;
  background-color: rgba(255,255,255,0.25);
  margin: 0 6px;
  border-radius: 2px;
}
/* === GAPS COLOR RULES (same floor vs diff floor) === */
.gap-same-floor {
  background-color: rgba(0, 255, 0, 0.12);  /* mais suave */
}

.gap-diff-floor {
  background-color: rgba(220, 53, 69, 0.18); /* vermelho claro suave */
}

.gap-critical {
  font-weight: bold;
  color: #dc3545; /* vermelho forte */
}

  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="logo-container">
      <!-- Logo da DHL na top bar -->
      <img src="dhl-logo.png" alt="DHL Logo" />
    </div>
    <span>Retail Pick Productivity Tracker</span>
    <!-- Bot√µes de Navega√ß√£o na Top Bar -->
    <div class="tab-nav">
      <button class="tab-btn" id="homeTabBtn" data-target="homeTabContent" title="Home">
        <i class="fa fa-home"></i><span class="btn-text">Home</span>
      </button>
      <button class="tab-btn" id="gapsTabBtn" data-target="gapsTabContent" title="Gaps">
        <i class="fa fa-chart-bar"></i><span class="btn-text">Gaps</span>
      </button>
    </div>
    <div class="user-info">Victor Ribeiro DHL(Supply Chain)</div>
  </div>
  <!-- Sidebar (fixa √† esquerda) -->
  <nav class="sidebar">
    <!-- Controles de Upload e Download com a classe de a√ß√£o -->
    <label for="csvFileInput" class="action-btn file-label">
      <i class="fa fa-file"></i> Choose CSV File
    </label>
    <input type="file" id="csvFileInput" accept=".csv" />
    <button id="downloadReportBtnXLSX" class="action-btn upload-btn">
      <i class="fa fa-download"></i> Download XLSX
    </button>
    <!-- Summary Cards com t√≠tulos (em branco) e n√∫meros (em dourado) -->
        <div class="summary-card">
      <div class="summary-title">Total User ID</div>
      <div class="summary-number" id="userCountLabel">0</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">User-equivalents Lost (‚âà)</div>
      <div class="summary-number" id="userLostLabel">0.00</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">T.W.H</div>
      <div class="summary-number" id="twhLabel">00:00:00</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Prod. Hours</div>
      <div class="summary-number" id="prodHoursLabel">00:00:00</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Total Gaps</div>
      <div class="summary-number" id="differenceLabel">00:00:00</div>
    </div>
<!-- ===== NEW PREMIUM KPI CARDS ===== -->

<!-- ===== KPI ROW: TOTAL & AVG PICKED ===== -->
<div class="kpi-row">
  <div class="kpi-card-small">
    <div class="summary-icon">üì¶</div>
    <div class="summary-title">Total Picked</div>
    <div class="summary-number" id="totalPickedLabel">0</div>
  </div>

  <div class="kpi-separator"></div>

  <div class="kpi-card-small">
    <div class="summary-icon">üìä</div>
    <div class="summary-title">Avg. Pick/h</div>
    <div class="summary-number" id="avgPickedLabel">0</div>
  </div>
</div>
<!-- NEW: Avg. Performance -->
<div class="summary-card kpi-card">
  <div class="summary-icon">üìà</div>
  <div class="summary-title">Avg. Performance</div>
  <div class="summary-number" id="avgPerformanceLabel">0%</div>
</div>

<!-- Median Performance (IQR) -->
<div class="summary-card kpi-card">
  <div class="summary-icon">üìâ</div>
  <div class="summary-title">Median Performance</div>
  <div class="summary-number" id="medianPerformanceLabel">0%</div>
</div>

  </nav>
  <!-- Main Content -->
  <div class="main-content">
    <!-- Conte√∫do da Aba Home -->
    <div id="homeTabContent">
      <table id="productivityTable">
        <thead>
          <tr>
            <th style="min-width:100px;">Date</th>
            <th>User ID</th>
            <th>Qty</th>
            <th>In Time</th>
            <th>Out Time</th>
            <th>Total Hours</th>
            <th>Prod. Hours</th>
            <th>Performance</th>
            <th>Total Gaps</th>
            <th>N. Gaps</th>
            <th>Qty. Tnx</th>
            <th>Gap vs Txn%</th>
            <th>Avg. P. Hours</th>
          </tr>
          <!-- Linha de Filtros Integrada no Cabe√ßalho -->
          <tr class="filter-row">
  <th></th>
  <th>
    <input
      type="text"
      id="filterUserId"
      placeholder="Filter by User ID"
      style="margin-bottom: 4px;"
    />
    <select id="filterUserType">
      <option value="">All</option>
      <option value="core">Core</option>
      <option value="agy">AGY</option>
    </select>
  </th>
  <th></th>
  <th></th>
  <th></th>
  <th></th>
  <th></th>
  <th>
    <select id="filterPerformance">
      <option value="">All</option>
      <option value="Well Done">Well Done</option>
      <option value="Almost There">Almost There</option>
      <option value="Poor">Poor</option>
      <option value="No Activity">No Activity</option>
    </select>
  </th>
  <th></th>
  <th></th>
  <th></th>
  <th></th>
  <th></th>
</tr>
        </thead>
        <tbody>
          <!-- Linhas din√¢micas geradas pela l√≥gica -->
        </tbody>
      </table>
    </div>
<div id="gapsTabContent" style="display: none;">
  <table id="gapsTable">
    <thead>
      <tr>
        <th style="min-width:100px;">Date</th>
        <th>User ID</th>
        <th>Location IN</th>
        <th>Location OUT</th>
        <th>In Time</th>
        <th>Out Time</th>
        <th>Gap Time</th>
        <th>Gap #</th>
      </tr>
      <!-- Linha de Filtros Integrada no Cabe√ßalho REMOVIDA -->
    </thead>
    <tbody>
          <!-- Linhas din√¢micas geradas pela l√≥gica -->
        </tbody>
      </table>
    </div>
  </div>
  <!-- L√≥gica JavaScript (100% inalterada) -->
  <script>
    /* ======================================================
     * Configura√ß√µes Globais para Retail Pick Tracker
     * ====================================================== */
    const trackerTarget = 209; // Target fixo de 209 unidades/hora

    /* ======================================================
     * Fun√ß√µes Utilit√°rias
     * ====================================================== */
    function timeToSeconds(time) {
      const [h, m, s] = time.split(':').map(Number);
      return (h || 0) * 3600 + (m || 0) * 60 + (s || 0);
    }

    function ensureTimeFormat(time) {
      const parts = time.split(':');
      return parts.length === 2 ? `${time}:00` : time;
    }

    function calculateSecondsDifference(start, end) {
      start = ensureTimeFormat(start.trim());
      end = ensureTimeFormat(end.trim());
      const startSec = timeToSeconds(start);
      const endSec = timeToSeconds(end);
      let diff = endSec - startSec;
      if (diff < 0) diff += 24 * 3600;
      return diff;
    }

    function formatDecimalToTime(decimalHours) {
      let sign = "";
      if (decimalHours < 0) {
        sign = "-";
        decimalHours = Math.abs(decimalHours);
      }
      const totalSeconds = Math.round(decimalHours * 3600);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return (
        sign +
        String(hours).padStart(2, '0') + ":" +
        String(minutes).padStart(2, '0') + ":" +
        String(seconds).padStart(2, '0')
      );
    }

    function formatDate(date) {
      if (!date) return '';
      const parts = date.split(/[^\d]/).filter(Boolean);
      if (parts.length === 3) {
        const [year, month, day] = parts.map(Number).sort((a, b) => a - b);
        return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
      }
      return date;
    }
// Agora n√£o reformatamos a data ‚Äî vem pronta do CSV novo
// (no teu c√≥digo atual podes manter o teu formatDate, isto √© s√≥ refer√™ncia)
function getFloor(location) {
  if (!location) return null;
  const loc = location.toUpperCase().trim();

  // Locs especiais tratados como "ground"
  if (loc.startsWith('DROP'))   return 'ground';
  if (loc.startsWith('CONSOL')) return 'ground';

  const letter = loc.charAt(0);
  const floorMap = {
    X: 'ground', Z: 'ground', A: 'ground', E: 'ground', P: 'ground', F: 'ground',
    B: 'bFloor', V: 'bFloor',
    D: 'dFloor', C: 'dFloor',
    T: 'tFloor', H: 'tFloor'
  };
  return floorMap[letter] || 'unknown';
}

function getUserType(userId) {
  const uid = (userId || "").toString().trim().toUpperCase();

  // AGY = come√ßa por "AGY"
  if (uid.startsWith("AGY")) {
    return "agy";
  }

  // CORE = tudo o resto
  return "core";
}


    /* ======================================================
     * Fun√ß√µes de Troca de Aba
     * ====================================================== */
    function setActiveTab(btnId) {
      const allBtns = document.querySelectorAll('.tab-btn');
      allBtns.forEach(b => b.classList.remove('active'));
      const btn = document.getElementById(btnId);
      if (btn) btn.classList.add('active');
    }

        function showHomeTab() {
      document.getElementById('homeTabContent').style.display = 'block';
      document.getElementById('gapsTabContent').style.display = 'none';
      setActiveTab('homeTabBtn');
    }

   function showGapsTab() {
  document.getElementById('homeTabContent').style.display = 'none';
  document.getElementById('gapsTabContent').style.display = 'block';
  setActiveTab('gapsTabBtn');

  const savedData = localStorage.getItem('retailPickData');
  if (savedData) {
    const dataMap = JSON.parse(savedData);
    applyFilters(dataMap);  // reaplica todos os filtros e atualiza a Gaps
  }
}




    /* ======================================================
     * Atualiza√ß√£o da Tabela Home
     * ====================================================== */
    function updateTable(dataMap) {
      const tableBody = document.querySelector('#productivityTable tbody');
      tableBody.innerHTML = '';

      Object.entries(dataMap).forEach(([userId, stats]) => {
        const { qty, inTime, outTime, totalHours, performance, performanceClass, totalGaps, nGaps, date, txnCount } = stats;
        const prodHours = formatDecimalToTime(qty / trackerTarget);
        const gapTxnPercent = txnCount ? ((nGaps / txnCount) * 100).toFixed(2) + "%" : "0.00%";
        const totalHoursDecimal = timeToSeconds(totalHours) / 3600;
        const avgPHours = totalHoursDecimal > 0 ? (qty / totalHoursDecimal).toFixed(0) : "0";
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="min-width:100px;">${date || ''}</td>
          <td>${userId}</td>
          <td>${qty}</td>
          <td>${inTime || 'N/A'}</td>
          <td>${outTime || 'N/A'}</td>
          <td>${totalHours || '00:00:00'}</td>
          <td>${prodHours}</td>
          <td class="${performanceClass}">${performance}</td>
          <td>${formatDecimalToTime(totalGaps)}</td>
          <td>${nGaps || 0}</td>
          <td>${txnCount}</td>
          <td>${gapTxnPercent}</td>
          <td>${avgPHours}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    /* ======================================================
     * Atualiza√ß√£o da Tabela Gaps
     * ====================================================== */
    function updateGapsTable(dataMap) {
  const gapsTableBody = document.querySelector('#gapsTable tbody');
  gapsTableBody.innerHTML = '';

  Object.entries(dataMap).forEach(([userId, stats]) => {
    if (stats.nGaps > 0 && stats.gapsList && stats.gapsList.length > 0) {
      stats.gapsList.forEach((gapObj, index) => {
        const gapMinutes = gapObj.gapSec / 60;
        const gapTimeFormatted = formatDecimalToTime(gapObj.gapSec / 3600);

        // Usa a mesma l√≥gica do c√≥digo acabado
        const floorIn  = getFloor(gapObj.locationIn);
        const floorOut = getFloor(gapObj.locationOut);
        const sameFloor = floorIn && floorOut && floorIn === floorOut;

        let rowClass = '';
        let gapCellClass = '';

        if (sameFloor) {
          // Linha sempre verde claro no mesmo floor
          rowClass = 'gap-same-floor';

          // Gap Time (mesmo floor):
          // < 5 min        ‚Üí normal
          // 5‚Äì7 min        ‚Üí normal (mant√©m fonte)
          // > 7 min        ‚Üí bold + vermelho
          if (gapMinutes > 7) {
            gapCellClass = 'gap-critical';
          }
        } else {
          // Linha sempre vermelha clara entre pisos
          rowClass = 'gap-diff-floor';

          // Gap Time (floors diferentes):
          // < 10 min       ‚Üí normal
          // 10‚Äì12 min      ‚Üí normal
          // > 12 min       ‚Üí bold + vermelho
          if (gapMinutes > 12) {
            gapCellClass = 'gap-critical';
          }
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${stats.date || ''}</td>
          <td>${userId}</td>
          <td>${gapObj.locationIn || ''}</td>
          <td>${gapObj.locationOut || ''}</td>
          <td>${gapObj.start || 'N/A'}</td>
          <td>${gapObj.end || 'N/A'}</td>
          <td class="${gapCellClass}">${gapTimeFormatted}</td>
          <td>${index + 1}</td>
        `;

        if (rowClass) {
          row.classList.add(rowClass);
        }

        gapsTableBody.appendChild(row);
      });
    }
  });
}
    /* ======================================================
     * Atualiza√ß√£o das Estat√≠sticas
     * ====================================================== */
        function updateStats(dataMap) {
  let sumWorkedHours = 0;   // T.W.H (Total Worked Hours)
  let sumProdHours   = 0;   // Prod. Hours (qty / target)
  let totalPicked    = 0;   // Soma total de QTY
  let sumGapsHours   = 0;   // Total Gaps (em horas decimais)

  Object.values(dataMap).forEach(stats => {
    const hoursDecimal = timeToSeconds(stats.totalHours) / 3600;
    sumWorkedHours += hoursDecimal;
    sumProdHours   += stats.qty / trackerTarget;
    totalPicked    += stats.qty;
    sumGapsHours   += stats.totalGaps || 0;
  });

  // === Summary cards principais ===
  document.getElementById('twhLabel').textContent        = formatDecimalToTime(sumWorkedHours);
  document.getElementById('prodHoursLabel').textContent  = formatDecimalToTime(sumProdHours);
  document.getElementById('differenceLabel').textContent = formatDecimalToTime(sumGapsHours); // Total Gaps

  const totalUsers = Object.keys(dataMap).length;
  document.getElementById('userCountLabel').textContent = totalUsers;

  const lostDecimal = sumGapsHours / 7.5;
document.getElementById('userLostLabel').textContent = lostDecimal.toFixed(2);


  // === KPIs do sidebar ===

  // 1) Total Picked (soma de todas as QTY)
  document.getElementById('totalPickedLabel').textContent =
  totalPicked.toLocaleString('en-US');


  // 2) Avg. Pick/h = Total Picked / Total Worked Hours
  const avgPickPerHour =
    sumWorkedHours > 0 ? (totalPicked / sumWorkedHours) : 0;
  document.getElementById('avgPickedLabel').textContent = avgPickPerHour.toFixed(0);

  // 3) Avg Performance & 4) Median Performance
  let sumPerformance = 0;
  const perfValues = [];

  Object.values(dataMap).forEach(stats => {
    const hours = timeToSeconds(stats.totalHours) / 3600;
    const perf  = hours > 0 ? (stats.qty / (hours * trackerTarget)) * 100 : 0;
    sumPerformance += perf;
    perfValues.push(perf);
  });

  const avgPerformance =
    totalUsers > 0 ? (sumPerformance / totalUsers) : 0;

  const avgPerfEl = document.getElementById('avgPerformanceLabel');
  if (avgPerfEl) {
    avgPerfEl.textContent = avgPerformance.toFixed(2) + '%';
  }

  // Mediana
  function median(arr) {
    if (!arr || arr.length === 0) return 0;
    const s = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(s.length / 2);
    return (s.length % 2 === 0)
      ? (s[mid - 1] + s[mid]) / 2
      : s[mid];
  }

  const medianPerformance = median(perfValues);
  const medianEl = document.getElementById('medianPerformanceLabel');
  if (medianEl) {
    medianEl.textContent = medianPerformance.toFixed(2) + '%';
  }
}



    /* ======================================================
     * Fun√ß√£o de Filtragem para a Aba Home
     * ====================================================== */
    function applyFilters(dataMap) {
  const performanceFilter = document.getElementById('filterPerformance').value;
  const userIdFilter      = document.getElementById('filterUserId').value.toLowerCase();
  const userTypeFilter    = document.getElementById('filterUserType').value; // "" | "core" | "agy"

  const filtered = Object.entries(dataMap).filter(([userId, stats]) => {
    const matchesPerformance =
      !performanceFilter || stats.performance.includes(performanceFilter);

    const matchesUserId =
      !userIdFilter || userId.toLowerCase().includes(userIdFilter);

    // se stats.userType n√£o existir, recalcula com base no pr√≥prio userId
    const userType = stats.userType || getUserType(userId);
    const matchesUserType =
      !userTypeFilter || userType === userTypeFilter;

    return matchesPerformance && matchesUserId && matchesUserType;
  });

  const filteredMap = Object.fromEntries(filtered);

  // Home
  updateTable(filteredMap);
  updateStats(filteredMap);

  // Gaps sincronizado com os mesmos filtros
  updateGapsTable(filteredMap);
}




    /* ======================================================
     * Fun√ß√£o para ajustar o tamanho da fonte nas c√©lulas do XLSX
     * ====================================================== */
    function setFontSize(sheet, size) {
      Object.keys(sheet).forEach(function(cell) {
        if(cell.startsWith('!')) return;
        if(!sheet[cell].s) sheet[cell].s = {};
        if(!sheet[cell].s.font) sheet[cell].s.font = {};
        sheet[cell].s.font.sz = size;
      });
    }

    /* ======================================================
     * L√≥gica Principal e Eventos
     * ====================================================== */
    document.getElementById('csvFileInput').addEventListener('change', handleFileUpload);
    document.getElementById('downloadReportBtnXLSX').addEventListener('click', downloadExcelReport);
    // Bot√µes de Navega√ß√£o na Top Bar
    document.getElementById('homeTabBtn').addEventListener('click', showHomeTab);
    document.getElementById('gapsTabBtn').addEventListener('click', showGapsTab);
    // Eventos para os filtros integrados
    document.getElementById('filterPerformance').addEventListener('change', () => {
  const savedData = localStorage.getItem('retailPickData');
  if (savedData) {
    const dataMap = JSON.parse(savedData);
    applyFilters(dataMap);
  }
});

document.getElementById('filterUserId').addEventListener('input', () => {
  const savedData = localStorage.getItem('retailPickData');
  if (savedData) {
    const dataMap = JSON.parse(savedData);
    applyFilters(dataMap);
  }
});

document.getElementById('filterUserType').addEventListener('change', () => {
  const savedData = localStorage.getItem('retailPickData');
  if (savedData) {
    const dataMap = JSON.parse(savedData);
    applyFilters(dataMap);
  }
});


        window.onload = function () {
      const savedData = localStorage.getItem('retailPickData');
      if (savedData) {
        const dataMap = JSON.parse(savedData);
        updateTable(dataMap);
        updateStats(dataMap);
        updateGapsTable(dataMap);
      }
      // Garante que a Home esteja vis√≠vel e o bot√£o fique marcado
      showHomeTab();
    };


    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        processCSV(e.target.result);
      };
      reader.readAsText(file);
    }

    function processCSV(csvText) {
      try {
        const delimiter = csvText.includes(',') ? ',' : '\t';
        const rows = csvText.split('\n').map(row => row.split(delimiter));

        const dateFromFile = rows[3]?.[1]?.trim();
        const formattedDate = formatDate(dateFromFile);

        const dataMap = {};
        const validEvents = {};
        const allEvents = {};

        // Ordena as linhas a partir da linha 5 pela coluna de tempo (√≠ndice 9)
        const sortedRows = rows.slice(5).sort((a, b) => {
          const timeA = a[9] || '';
          const timeB = b[9] || '';
          return timeA.localeCompare(timeB);
        });

        sortedRows.forEach(row => {
          const userId = row[0]?.trim();
          const qty = parseInt(row[5]?.trim(), 10) || 0;
          const time = row[9]?.trim();
          const location = row[7]?.trim();

          if (!userId || !time) return;

          if (!dataMap[userId]) {
            dataMap[userId] = {
  qty: 0,
  inTime: null,
  outTime: null,
  totalHours: 0,
  performance: '',
  performanceClass: '',
  totalGaps: 0,
  nGaps: 0,
  date: formattedDate,
  txnCount: 0,
  locationIn: '',
  locationOut: '',
  gapsList: [],
  userType: getUserType(userId)
};

            validEvents[userId] = [];
            allEvents[userId] = [];
          }

          dataMap[userId].qty += qty;
          dataMap[userId].txnCount++;
          allEvents[userId].push({ time: time, location: location });
          validEvents[userId].push({ time: time, location: location });

          if (!dataMap[userId].inTime || time < dataMap[userId].inTime) {
            dataMap[userId].inTime = time;
            dataMap[userId].locationIn = location || '';
          }
          if (!dataMap[userId].outTime || time > dataMap[userId].outTime) {
            dataMap[userId].outTime = time;
            dataMap[userId].locationOut = location || '';
          }
        });

        Object.keys(allEvents).forEach(userId => {
          allEvents[userId] = allEvents[userId]
            .filter((obj, i, arr) => arr.findIndex(o => o.time === obj.time) === i)
            .sort((a, b) => a.time.localeCompare(b.time));
        });
        Object.keys(validEvents).forEach(userId => {
          validEvents[userId] = validEvents[userId]
            .filter((obj, i, arr) => arr.findIndex(o => o.time === obj.time) === i)
            .sort((a, b) => a.time.localeCompare(b.time));
        });

        Object.keys(validEvents).forEach(userId => {
          const events = validEvents[userId];
          const userAll = allEvents[userId];
          for (let i = 1; i < events.length; i++) {
            const prevObj = events[i - 1];
            const currObj = events[i];
            const prev = prevObj.time;
            const curr = currObj.time;
            const diffSec = calculateSecondsDifference(prev, curr);
            const gapHours = diffSec / 3600;
            const intermediate = userAll.some(ev => ev.time > prev && ev.time < curr);
            if (gapHours >= 0.0833 && !intermediate) {
              dataMap[userId].totalGaps += gapHours;
              dataMap[userId].nGaps += 1;
              dataMap[userId].gapsList.push({ 
                gapSec: diffSec, 
                start: prev, 
                end: curr, 
                locationIn: prevObj.location, 
                locationOut: currObj.location 
              });
            }
          }
        });

        Object.keys(dataMap).forEach(userId => {
          const data = dataMap[userId];
          if (!data.inTime || !data.outTime) {
            delete dataMap[userId];
            return;
          }
          const totalHoursDecimal = calculateSecondsDifference(data.inTime, data.outTime) / 3600;
          data.totalHours = formatDecimalToTime(totalHoursDecimal);

          if (totalHoursDecimal <= 0) {
            data.performance = "No Activity (0.00%)";
            data.performanceClass = "performance-no-activity";
          } else {
            const performance = data.qty > 0 ? (data.qty / (totalHoursDecimal * trackerTarget)) * 100 : 0;
            if (performance >= 100) {
              data.performance = `Well Done (${performance.toFixed(2)}%)`;
              data.performanceClass = "performance-well-done";
            } else if (performance >= 85) {
              data.performance = `Almost There (${performance.toFixed(2)}%)`;
              data.performanceClass = "performance-almost-there";
            } else if (performance > 0) {
              data.performance = `Poor (${performance.toFixed(2)}%)`;
              data.performanceClass = "performance-poor";
            } else {
              data.performance = "No Activity (0.00%)";
              data.performanceClass = "performance-no-activity";
            }
          }
          data.txnCount = validEvents[userId].length;
        });

        localStorage.setItem('retailPickData', JSON.stringify(dataMap));
        updateTable(dataMap);
        updateStats(dataMap);
        updateGapsTable(dataMap);
      } catch (error) {
        console.error("Error processing CSV:", error);
      }
    }

    function downloadExcelReport() {
      const savedData = localStorage.getItem('retailPickData');
      if (!savedData) {
        alert('No data to download. Please upload a file first.');
        return;
      }
      
      const dataMap = JSON.parse(savedData);
      const header = ['Date', 'User ID', 'Qty', 'In Time', 'Out Time', 'Total Hours', 'Prod. Hours', 'Performance', 'Total Gaps', 'N. Gaps', 'Qty. Tnx', 'Gap vs Txn%', 'Avg. P. Hours'];
      const allData = [header.slice()];
      const wellDoneData = [header.slice()];
      const almostThereData = [header.slice()];
      const poorData = [header.slice()];
  
      Object.entries(dataMap).forEach(([userId, stats]) => {
        const { qty, inTime, outTime, totalHours, performance, totalGaps, nGaps, date, txnCount } = stats;
        const prodHours = formatDecimalToTime(qty / trackerTarget);
        const gapTxnPercent = txnCount ? ((nGaps / txnCount) * 100).toFixed(2) + "%" : "0.00%";
        const totalHoursDecimal = timeToSeconds(totalHours) / 3600;
        const avgPHours = totalHoursDecimal > 0 ? (qty / totalHoursDecimal).toFixed(2) : "0";
        
        const row = [
          date,
          userId,
          qty,
          inTime,
          outTime,
          totalHours,
          prodHours,
          performance,
          formatDecimalToTime(totalGaps),
          nGaps,
          txnCount,
          gapTxnPercent,
          avgPHours
        ];
        allData.push(row);
        if (performance.includes('Well Done')) {
          wellDoneData.push(row);
        } else if (performance.includes('Almost There')) {
          almostThereData.push(row);
        } else if (performance.includes('Poor')) {
          poorData.push(row);
        }
      });
      
      const gapsHeader = ['Date', 'User ID', 'Location IN', 'Location OUT', 'In Time', 'Out Time', 'Gap Time', 'Gap #'];
      const gapsData = [gapsHeader.slice()];
      Object.entries(dataMap).forEach(([userId, stats]) => {
        if (stats.nGaps > 0 && stats.gapsList && stats.gapsList.length > 0) {
          stats.gapsList.forEach((gapObj, index) => {
            const gapTimeFormatted = formatDecimalToTime(gapObj.gapSec / 3600);
            const row = [
              stats.date,
              userId,
              gapObj.locationIn || '',
              gapObj.locationOut || '',
              gapObj.start,
              gapObj.end,
              gapTimeFormatted,
              index + 1
            ];
            gapsData.push(row);
          });
        }
      });
  
      const workbook = XLSX.utils.book_new();
      const wsAll = XLSX.utils.aoa_to_sheet(allData);
      const wsWellDone = XLSX.utils.aoa_to_sheet(wellDoneData);
      const wsAlmostThere = XLSX.utils.aoa_to_sheet(almostThereData);
      const wsPoor = XLSX.utils.aoa_to_sheet(poorData);
      const wsGaps = XLSX.utils.aoa_to_sheet(gapsData);
  
      setFontSize(wsAll, 11);
      setFontSize(wsWellDone, 11);
      setFontSize(wsAlmostThere, 11);
      setFontSize(wsPoor, 11);
      setFontSize(wsGaps, 11);
  
      XLSX.utils.book_append_sheet(workbook, wsAll, "All Data");
      XLSX.utils.book_append_sheet(workbook, wsWellDone, "Well Done");
      XLSX.utils.book_append_sheet(workbook, wsAlmostThere, "Almost There");
      XLSX.utils.book_append_sheet(workbook, wsPoor, "Poor");
      XLSX.utils.book_append_sheet(workbook, wsGaps, "Gaps Breakdown");
  
      XLSX.writeFile(workbook, "Retail_Pick_Report.xlsx");
    }
  </script>
</body>
</html>
